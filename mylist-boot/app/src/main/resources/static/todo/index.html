<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8" />
        <title>To-do</title>
        <style>
            .todo-checked {
                text-decoration: line-through;
                color: gray;
            }
            .todo-editing {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>To-do</h1>
        <p>추가 <input id="x-todo-input" type="text" /></p>
        <table id="x-todo-table" border="1">
            <thead>
                <tr>
                    <th></th>
                    <th>해야 할 일</th>
                    <th>변경</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <input type="text" id="x-title-input" />
        <button class="test-btn">고질라</button>
        <div class="gogila-div" style="height: 200px"></div>

        <script type="text/javascript" src="myQuery.js"></script>
        <script type="text/javascript">
            'use strict';

            var titleInput = $('#x-title-input');
            titleInput.style['display'] = 'none';

            var tbody = $('#x-todo-table tbody');

            $('#x-todo-input').keyup(function (e) {
                if (e.keyCode == 27) {
                    e.target.value = '';
                } else if (e.keyCode == 13) {
                    if ($(e.target).val() == '') {
                        alert('필수 입력 항목이 비어 있습니다.');
                        return;
                    }
                    fetch(`/todo/add?title=${e.target.value}`)
                        .then(function (response) {
                            return response.text();
                        })
                        .then(function (text) {
                            console.log(text);
                            location.reload();
                        });
                }
            });

            fetch('/todo/list')
                .then(function (response) {
                    return response.json();
                })
                .then(function (todoList) {
                    //console.log(todoList);
                    for (var i = 0; i < todoList.length; i++) {
                        var checkedOption = '';
                        var titleTdOption = '';

                        if (todoList[i].done) {
                            checkedOption = 'checked';
                            titleTdOption = "class='todo-checked'";
                        }

                        $('<tr>').attr('data-no', i)
                            .html(`<td><input type="checkbox" ${checkedOption} onchange="checkTodo(${i}, event.target.checked)"></td>
                            <td class='todo-title'><span ${titleTdOption}>${todoList[i].title}</span></td>
                            <td>
                            <button class='x-update-btn-${i}' type="button" onclick="updateTodo(${i})">변경</button>
                            <button type="button" onclick="cancleTodo(${i})" style='display:none;'>취소</button>
                            </td>
                            <td><button type="button" onclick="deleteTodo(${i})">삭제</button></td>`)
                            .appendTo(tbody);
                    }
                    document.querySelector('#x-todo-input').focus();
                });

            function deleteTodo(no) {
                fetch(`/todo/delete?index=${no}`)
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (result) {
                        if (result == 0) {
                            window.alert('삭제하지 못했습니다!');
                        } else {
                            location.reload();
                        }
                    });
            }

            function checkTodo(no, checked) {
                console.log(no, checked);
                fetch(`/todo/check?index=${no}&done=${checked}`)
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (result) {
                        if (result == 0) {
                            window.alert('변경하지 못했습니다!');
                        } else {
                            var titleSpan = document.querySelector(
                                `tr[data-no="${no}"] td.todo-title > span`
                            );
                            if (checked) {
                                titleSpan.addClass('todo-checked');
                            } else {
                                titleSpan.removeClass('todo-checked');
                            }
                        }
                    });
            }

            function updateTodo(no) {
                console.log(no);
                // 현재 Todo 항목을 편집 중인 상태에서 변경 버튼을 눌렀다면
                if (titleInput.parentNode instanceof HTMLTableCellElement) {
                    // 다른 항목을 편집하기 위해 이동하기 전에 편집 전의 상태로 되돌린다.
                    titleInput.parent().find('span').css('display', '');
                }
                var titleTd = $(`tr[data-no="${no}"] > td.todo-title`);
                var titleSpan = titleTd.find('span');
                titleSpan.css('display', 'none');
                titleInput.val(titleSpan.html());
                titleInput.attr('data-no', no);
                titleTd.append(titleInput);
                titleInput.css('display', '');

                titleTd;
            }

            titleInput.keyup(function (e) {
                var no = titleInput.attr('data-no');
                var titleSpan = titleInput.parent().querySelector('span');
                var originTitle = titleSpan.html();

                if (e.keyCode == 27) {
                    //ESC를 눌러 편집을 취소한다면
                    cancleTodoEditing();
                } else if (
                    e.keyCode == 13 &&
                    titleInput.value != '' &&
                    originTitle != titleInput.value
                ) {
                    fetch(`/todo/update?index=${no}&title=${titleInput.value}`)
                        .then(function (response) {
                            return response.json();
                        })
                        .then(function (result) {
                            if (result == 0) {
                                window.alert('변경하지 못했습니다!');
                            } else {
                                console.log('변경했습니다.');
                                titleSpan.html() = titleInput.val();
                                cancleTodoEditing();
                                location.reload();
                            }
                        });
                }
            });

            function cancleTodoEditing() {
                titleInput.parent().find('span').css('display', '');
                titleInput.css('display', 'none');
                $(document.body).append(titleInput);
            }

            $('.test-btn').onclick = function () {
                console.log('gooooooo');
                var godiv = $('.gogila-div');
                godiv.go('goooo');
                $('.go').css('background-color', 'green');
                $('.go').css('width', '200px');
                $('.go').css('margin', '10px');
                $('.go').css('border-width', '2px');
                $('.go').css('border-color', 'black');
            };
        </script>
    </body>
</html>
